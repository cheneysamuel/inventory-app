<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="app-components.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="ext_lib/jquery-3.6.0.min.js"></script>
    <script src="ext_lib/select2.min.js"></script>
    <link rel="stylesheet" href="ext_lib/select2.min.css">
    <script src="ext_lib/xlsx.full.min.js"></script>
    <script src="ext_lib/exceljs.min.js"></script>
    <script src="ext_lib/pdf-lib.min.js"></script>
    <script src="ext_lib/signature_pad.umd.min.js"></script>
</head>
<body>
    <!-- HTML Templates for reducing programmatic DOM creation -->
    <!-- Templates are hidden and will be cloned when needed -->
    <div id="templates-container" style="display: none;">
        
        <!-- Generic Data Table Template -->
        <template id="data-table-template">
            <table class="inventory-table">
                <thead>
                    <tr data-bind="header-row">
                        <!-- Header cells populated dynamically -->
                    </tr>
                </thead>
                <tbody data-bind="table-body">
                    <!-- Rows populated dynamically -->
                </tbody>
            </table>
        </template>

        <!-- Issue Action Modal Template -->
        <template id="issue-action-modal-template">
            <div class="modal-content-wrapper">
                <!-- Crew/Area Selection Section (conditionally shown) -->
                <div data-bind="selection-section" style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f9fafb; border-radius: 0.375rem; display: none;">
                    <h4 style="margin: 0 0 1rem 0">Assign To:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500">Crew:</label>
                            <select id="issue-crew-select" class="form-control" style="font-size: 18px; padding: 8px; width: 100%">
                                <option value="">-- Select Crew --</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500">Area:</label>
                            <select id="issue-area-select" class="form-control" style="font-size: 18px; padding: 8px; width: 100%">
                                <option value="">-- Select Area --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Items Table -->
                <table class="inventory-table" style="margin-bottom: 1rem">
                    <thead>
                        <tr>
                            <th>Item Type</th>
                            <th>Serial/ID</th>
                            <th>Quantity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody data-bind="items-list">
                        <!-- Items populated dynamically -->
                    </tbody>
                </table>

                <!-- Summary Section -->
                <div data-bind="summary-section" style="margin-top: 1.5rem; padding: 1rem; background-color: #eff6ff; border-radius: 0.375rem">
                    <h4 style="margin: 0 0 0.5rem 0">Issue Summary:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem">
                        <div><strong>Total Items:</strong> <span data-bind="total-items"></span></div>
                        <div><strong>Total Quantity:</strong> <span data-bind="total-quantity"></span></div>
                        <div data-bind="crew-display" style="display: none"><strong>Crew:</strong> <span data-bind="crew-name"></span></div>
                        <div data-bind="area-display" style="display: none"><strong>Area:</strong> <span data-bind="area-name"></span></div>
                    </div>
                </div>

                <!-- Signature Section (conditionally shown) -->
                <div data-bind="signature-section" style="margin-top: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; display: none">
                    <h4 style="margin: 0 0 0.5rem 0">Signature (Optional):</h4>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem">Sign below to include signature on receipt</p>
                    <div style="border: 2px solid #d1d5db; border-radius: 0.375rem; background-color: #fff">
                        <canvas id="signature-canvas" style="display: block; width: 100%; height: 150px; touch-action: none"></canvas>
                    </div>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem">
                        <button data-action="clear-signature" class="btn btn-secondary" style="font-size: 0.875rem">Clear Signature</button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Item Types Table Template -->
        <template id="item-types-table-template">
            <table id="item-types-table" class="inventory-table item-types-sticky-header">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Manufacturer</th>
                        <th>Part #</th>
                        <th>Description</th>
                        <th class="text-center">Units/Pkg</th>
                        <th>UOM</th>
                        <th>Category</th>
                        <th>Provider</th>
                        <th class="text-center">Low Qty Alert</th>
                        <th class="markets-column">Markets</th>
                        <th class="text-center">Use Count</th>
                    </tr>
                </thead>
                <tbody data-bind="table-body">
                    <!-- Rows populated dynamically -->
                </tbody>
            </table>
        </template>
        
        <!-- Hierarchy Item Type Group Template -->
        <template id="hierarchy-item-type-group-template">
            <div class="item-type-group">
                <div class="item-type-header">
                    <span data-bind="item-type-name"></span>
                    <span class="item-count-badge" data-bind="item-count"></span>
                </div>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Crew</th>
                            <th>Area</th>
                            <th>Mfgr. SN</th>
                            <th>Tilson SN</th>
                            <th>Quantity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody data-bind="items-body">
                        <!-- Items populated dynamically -->
                    </tbody>
                </table>
            </div>
        </template>
        
    </div>
    
    <!-- Loading Screen (shown while checking authentication) -->
    <div id="loading-screen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center; color: white;">
            <h1 style="margin-bottom: 1rem;">üîê Checking Authentication...</h1>
            <div style="font-size: 2rem;">‚è≥</div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="change-password-modal" class="auth-overlay" style="display: none;">
        <div class="auth-container" style="max-width: 450px;">
            <h2>Change Password</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Enter your current password and choose a new password.</p>
            
            <form id="change-password-form">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" class="form-control" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" class="form-control" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                    <small style="color: #666; display: block; margin-top: 0.25rem;">Minimum 6 characters</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="button" id="cancel-password-change-btn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update Password</button>
                </div>
                
                <div id="change-password-error" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>
                <div id="change-password-success" class="alert alert-success" style="display: none; margin-top: 1rem;"></div>
            </form>
        </div>
    </div>

    <!-- Main Application (shown after authentication) -->
    <div id="app" style="display: none;">
        <!-- Mobile Menu Toggle Button -->
        <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
            </svg>
        </button>
        
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2>Inventory System</h2>
                <div id="user-info" class="user-info">
                    <div class="user-dropdown">
                        <button id="user-menu-btn" class="user-menu-btn">
                            <strong id="user-email" class="user-email-text"></strong>
                            <svg class="user-menu-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M2 4h12v1.5H2V4zm0 4h12v1.5H2V8zm0 4h12v1.5H2V12z"/>
                            </svg>
                        </button>
                        <div id="user-dropdown-menu" class="user-dropdown-menu" style="display: none;">
                            <button id="change-password-btn" class="user-dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 0.5rem;">
                                    <path d="M8 1a3.5 3.5 0 0 0-3.5 3.5V7H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1h-1.5V4.5A3.5 3.5 0 0 0 8 1zm2 6V4.5a2 2 0 1 0-4 0V7h4z"/>
                                </svg>
                                Change Password
                            </button>
                            <button id="logout-btn" class="user-dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 0.5rem;">
                                    <path d="M10 2v2h3v8h-3v2h5V2h-5zM7 4L3 8l4 4v-3h6V7H7V4z"/>
                                </svg>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="context-selectors">
                <div class="form-group">
                    <label for="clientSelect">Client:</label>
                    <select id="clientSelect" class="form-control">
                        <option value="">Select Client</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="marketSelect">Market:</label>
                    <select id="marketSelect" class="form-control">
                        <option value="">Select Market</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="slocSelect">SLOC:</label>
                    <select id="slocSelect" class="form-control">
                        <option value="">Select SLOC</option>
                    </select>
                </div>
            </div>
            
            <div class="nav-section">
                <h3>Main Operations</h3>
                <button class="nav-btn" data-view="dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-view="receive-serialized">üî¢ Manage Serialized Items</button>
                <button class="nav-btn" data-view="receive-bulk">üì¶ Rcv/Issue Bulk Items</button>
                <button class="nav-btn" data-view="inventory-view">üìã Manage Bulk Items</button>
                <button class="nav-btn" data-view="transactions">üìú Transactions</button>
            </div>
            
            <div class="nav-section">
                <h3>Configuration</h3>
                <button class="nav-btn" data-view="preferences">‚öôÔ∏è Preferences</button>
                <button class="nav-btn" data-view="manage-items">üîß Item Types</button>
                <button class="nav-btn" data-view="manage-crews">üë• Crews</button>
                <button class="nav-btn" data-view="manage-areas">üè¢ Clients/Markets/SLOCs/Areas</button>
            </div>
            
            <div class="nav-section">
                <h3>Import/Export</h3>
                <button class="nav-btn" data-view="export">üìä Export Data</button>
                <button class="nav-btn" data-view="import">üì• Import Data</button>
            </div>
        </nav>
        
        <!-- Main Content Area -->
        <main id="main-content" class="main-content">
            <div id="view-container"></div>
        </main>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>
    
    <!-- Application Scripts (Order matters for functional composition) -->
    <script src="js/config/supabase.config.js"></script>
    <script src="js/utils/functional.js"></script>
    <script src="js/utils/dom.js"></script>
    <script src="js/db/database.js"></script>
    <script src="js/db/queries.js"></script>
    <script src="js/db/consolidation.js"></script>
    <script src="js/state/store.js"></script>
    <script src="js/services/edge-functions.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/services/transactions.js"></script>
    <script src="js/services/validation.js"></script>
    <script src="js/services/import-item-types.js"></script>
    <script src="js/services/import-inventory.js"></script>
    <script src="js/services/import-new-inventory.js"></script>
    <script src="js/services/export-helpers.js"></script>
    <script src="js/services/import-export.js"></script>
    <script src="js/services/inventory-actions.js"></script>
    <script src="js/services/inventory-processing.js"></script>
    <script src="js/ui/components.js"></script>
    <script src="js/ui/modals.js"></script>
    <script src="js/ui/inventory-modals.js"></script>
    <!-- View Helper Modules (loaded before views.js) -->
    <script src="js/ui/bulk-receive-helpers.js"></script>
    <script src="js/ui/bulk-receive-process.js"></script>
    <script src="js/ui/bulk-issue-ui.js"></script>
    <script src="js/ui/preferences-helpers.js"></script>
    <script src="js/ui/manage-items-helpers.js"></script>
    <script src="js/ui/export-data-helpers.js"></script>
    <script src="js/ui/receive-serialized-helpers.js"></script>
    <script src="js/ui/transactions-helpers.js"></script>
    <script src="js/ui/serialized-modal-helpers.js"></script>
    <script src="js/ui/serialized-modals-actions.js"></script>
    <script src="js/ui/ui-helpers.js"></script>
    <script src="js/ui/item-type-management.js"></script>
    <script src="js/ui/form-utilities.js"></script>
    <script src="js/ui/hierarchy-crud.js"></script>
    <script src="js/ui/serialized-workflows.js"></script>
    <script src="js/ui/import-preview.js"></script>
    <script src="js/ui/views.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
